{%- comment -%}
------------------------------------------------------------------------------
	Section: Cart drawer
------------------------------------------------------------------------------
{%- endcomment -%}

{%- assign design = settings.design -%}

{%- if design == 'standard' -%}
	{{- 'cart.build.css' | asset_url | stylesheet_tag -}}
{%- elsif design == 'alternate' -%}
	{{- 'cart-new.build.css' | asset_url | stylesheet_tag -}}
{%- endif -%}

{%- capture default_heading -%}
	{{- "cart.general.title" | t -}}
{%- endcapture -%}

{%- assign show_cart_items_count = section.settings.show_cart_items_count -%}
{%- assign show_gift_wrap_button = section.settings.show_gift_wrap_button -%}
{%- assign heading = section.settings.heading | default: default_heading -%}

{%- if show_cart_items_count -%}
	{%- capture heading -%}
		{%- if cart.item_count > 0 -%}
			{{- heading }} ({{- cart.item_count -}})
		{%- else -%}
			{{- heading }}
		{%- endif -%}
	{%- endcapture -%}
{%- endif -%}

{%- assign shipping_included = false -%}

{%- capture subtotal -%}
	{%- if cart.cart_level_discount_applications.size > 0 -%}
		<div class="cart-drawer__savings">
			<div class="cart-drawer__subtotal cart-drawer__subtotal--savings">
				<span class="cart-drawer__subtotal-label">
					{{- 'cart.general.savings' | t | append: ':' -}}
				</span>

				<span class="cart-drawer__subtotal-value cart-drawer__subtotal-value--save">
					{{- cart.total_discount | money | prepend: '-' -}}
				</span>
			</div>

			<ul class="discounts discounts--right cart-drawer__discounts" role="list" aria-label="{{- 'customer.order.discount' | t | escape -}}">
				{%- for discount in cart.cart_level_discount_applications -%}
					<li class="discounts__item">
						{% render 'icons-small', icon: 'discount' %}

						{{ discount.title }}
						(-{{ discount.total_allocated_amount | money }})
					</li>
				{%- endfor -%}
			</ul>
		</div>
	{%- endif -%}

	<p class="cart-drawer__subtotal">
		<span class="cart-drawer__subtotal-label">
			{{- 'cart.general.subtotal' | t | append: ':' -}}
		</span>

		<span class="cart-drawer__subtotal-value">
			{{- cart.total_price | money -}}
		</span>
	</p>
{%- endcapture -%}

{%- capture content -%}
	{%- for block in section.blocks -%}
		{%- case block.type -%}
			{%- when '@app' -%}
				{%- render block -%}
			{%- when 'items' -%}
				<div class="cart-drawer__section cart-drawer__section--items">
					<div class="{% if design == 'standard' %}cart-items{% elsif design == 'alternate' %}cart-items-new{% endif %}">
						<form action="{{- routes.cart_url -}}" id="cart-{{- section.id -}}" class="cart-items__form" method="post">
							<div class="cart-items__body">
								{%- render 'cart-items', cart_drawer: true -%}
							</div>
						</form>
					</div>
				</div>
			{%- when 'upsell' -%}
				{%- assign upsell_heading = block.settings.heading -%}
				{%- assign products       = block.settings.product_list -%}

				{%- capture upsell_content -%}
					{%- render 'cart-upsell',
						products: products,
						heading: upsell_heading
					-%}
				{%- endcapture -%}

				{%- if upsell_content != '' -%}
					<div class="cart-drawer__section cart-drawer__section--upsell js-cart-upsell">
						{{- upsell_content -}}
					</div>
				{%- endif -%}
			{%- when 'shipping' -%}
				{%- assign amount  = block.settings.amount -%}
				{%- assign message = block.settings.message -%}
				{%- assign congratulatory_message = block.settings.congratulatory_message -%}
				{%- assign congratulatory_image   = block.settings.icon -%}

				{%- capture shipping_content -%}
					{%- if amount != nil and message != nil and congratulatory_message != nil -%}
						{%- assign cart_total   = cart.total_price -%}
						{%- assign amount_cents = amount | abs | times: 100.0 -%}
						{%- assign percentage   = cart_total | divided_by: amount_cents | times: 100 -%}

						{%- capture styles -%}
							--shipping-bar-progress-value: {{ percentage -}}%;
						{%- endcapture -%}

						{%- capture icon -%}
							{%- if congratulatory_image != blank -%}
								{%- capture img_focal -%}
									--img-desktop-pos: {{ congratulatory_image.presentation.focal_point }};
								{%- endcapture -%}

								<img
									class="cart-drawer__shipping-image"
									srcset="{{ congratulatory_image | img_url: "20x" }} 1x, {{ congratulatory_image | img_url: "40x" }} 2x"
									src="{{- congratulatory_image | img_url: "40x" -}}"
									alt="{{- congratulatory_image.alt -}}"
									style="{{ img_focal }}"
								/>
							{%- endif -%}
						{%- endcapture -%}

						<div
							class="cart-drawer__shipping js-cart-shipping"
							style="{{- styles -}}"
							data-amount-cents="{{ amount_cents }}"
							data-cart-total="{{ cart_total }}"
							data-amount-message="{{ message | escape }}"
							data-success-message="{{ congratulatory_message | escape }}"
						>
							<div class="cart-drawer__shipping-content">
								<p class="cart-drawer__shipping-label">
									{%- if icon != '' -%}
										<span class="cart-drawer__shipping-icon js-cart-shipping-icon is-hidden">
											{{- icon -}}
										</span>
									{%- endif -%}

									<span class="js-cart-shipping-amount-msg"></span>
								</p>

								<div class="cart-drawer__shipping-progress js-cart-shipping-progress-bar">
									<span class="visually-hidden js-shipping-bar-progress-hidden-text"></span>
								</div>
							</div>
						</div>
					{%- endif -%}
				{%- endcapture -%}

				{%- if shipping_content != '' -%}
					<div class="cart-drawer__section cart-drawer__section--shipping">
						{%- assign shipping_included = true -%}

						{{- shipping_content -}}
					</div>
				{%- endif -%}
			{%- when 'richtext' -%}
				{%- assign text						= block.settings.text -%}
				{%- assign text_color				= block.settings.text_color -%}
				{%- assign text_background_color	= block.settings.text_background_color -%}

				{%- if text != blank -%}
					<div class="cart-drawer__section cart-drawer__section--richtext" style=" --richtext-color: {{ text_color }}; --richtext-background-color: {{ text_background_color }};">
						<p>
							{{- text -}}
						</p>
					</div>
				{%- endif -%}
		{%- endcase -%}
	{%- endfor -%}
{%- endcapture -%}

{%- capture footer -%}
	{%- render 'cart-footer', section: section, show_payments: false, show_gift_button: show_gift_wrap_button, note_accordion: true -%}
{%- endcapture -%}

{% liquid
	assign discount_codes = cart.cart_level_discount_applications | where: 'type', 'discount_code' | map: 'title'
	for item in cart.items
		for allocation in item.line_level_discount_allocations
			if allocation.discount_application.type == 'discount_code'
				assign discount_codes = item.line_level_discount_allocations | slice: forloop.index0 | map: 'discount_application' | map: 'title' | concat: discount_codes
			endif
		endfor
	endfor

	assign discount_codes = discount_codes | uniq
%}

<section
	id="CartDrawer"
	class="drawer drawer--right{% if design == 'standard' %} cart-drawer{% elsif design == 'alternate' %} drawer--new cart-drawer-new{% endif %}{% if cart.empty? %} is-empty{% endif %}"
	data-section-type="cart-template"
	data-section-modification="drawer"
	data-section-id="{{- section.id -}}"
	role="dialog"
	aria-labelledby="CartDrawer-{{- heading | handle -}}"
>
	<div class="drawer__body cart-drawer__container js-cart-container" data-scrollable>
		<div class="cart-drawer__content js-cart-content">
			<div class="drawer__header cart-drawer__heading">
				<h2 class="drawer__title" id="CartDrawer-{{- heading | handle -}}">
					{{- heading -}}
				</h2>

				<button
					class="drawer__close focus-visible-outline cart-drawer__close js-cart-close-button"
					data-target="CartDrawer"
					data-js-toggle="CartDrawer"
					aria-label="{{- 'general.accessibility.close_modal' | t | escape -}}"
				>
					{%- if design == 'standard' -%}
						{% render 'icons-small', icon: 'close' %}
					{%- elsif design == 'alternate' -%}
						{%- render 'icons-new', icon: 'close' -%}
					{%- endif -%}
				</button>
			</div>

			{%- if cart.empty? -%}
				{%- render 'cart-empty' -%}
			{%- else -%}
				{%- if content != '' -%}
					{{- content -}}
				{%- endif -%}

				<div class="cart-drawer__section cart-drawer__section--subtotal">
					{{- subtotal -}}
				</div>

				{%- if settings.show_cart_discounts -%}
					<div
						class="cart-drawer__section cart-drawer__section--discount-form accordion js-cart-discount-accordion-container js-accordion-container">
						<div class="cart-drawer__accordion-item accordion__item js-accordion-item">
							<button
								class="cart-drawer__discount-form-label cart-drawer__accordion-control accordion__control js-accordion-control"
								aria-controls="cart-drawer-discounts"
								aria-expanded="false"
							>
								{{- "cart.general.discount_accordion_button" | t -}}

								{%- if design == 'standard' -%}
									<span class="cart-drawer__discount-form-icon cart-drawer__discount-form-icon-plus">
									{%- render 'icons-small', icon: 'plus' -%}
								</span>

									<span class="cart-drawer__discount-form-icon cart-drawer__discount-form-icon-minus">
									{%- render 'icons-small', icon: 'minus' -%}
								</span>
								{%- elsif design == 'alternate' -%}
									<span class="cart-drawer__discount-form-icon">
									{%- render "icons-new", icon: "arrow-down" -%}
								</span>
								{%- endif -%}
							</button>

							<div
								class="cart-drawer__accordion-content accordion__content accordion__content--animate js-accordion-content"
								id="cart-drawer-discounts">
								<div class="js-accordion-inner">
									<form class="cart-drawer__discount-form js-cart-discount-form" novalidate>
										<div class="input-wrapper cart-drawer__discount-form-input-wrapper">
											<label class="visually-hidden" for="cart-discount">
												{{- "cart.general.discount" | t -}}
											</label>

											<input
												class="input cart-drawer__discount-form-form-input"
												type="text"
												id="cart-discount"
												name="discount"
												placeholder="{{- 'cart.general.discount_placeholder' | t -}}"
											/>
										</div>

										<button
											class="{% if design == 'standard' %}button{% elsif design == 'alternate' %}button-new{% endif %} button--secondary cart-drawer__discount-form-button js-cart-discount-apply-button"
											type="submit"
										>
											{{- "cart.general.apply_discount" | t -}}
										</button>
									</form>

									<div
										class="cart-drawer__discount-form-error js-cart-discount-error is-hidden"
										role="alert">
									<span class="cart-drawer__discount-form-error-icon-wrapper">
										{% render 'icons-small', icon: 'error' %}
									</span>

										<span
											class="cart-drawer__discount-form-error-text js-cart-discount-error-code is-hidden">
										{{ 'cart.general.discount_code_error' | t }}
									</span>

										<small
											class="cart-drawer__discount-form-error-text js-cart-discount-error-shipping is-hidden">
											{{ 'cart.general.shipping_discount_error' | t }}
										</small>
									</div>

									{%- if discount_codes.size > 0 -%}
										<ul class="cart-drawer__discount-codes">
											{% for discount_code in discount_codes %}
												<li
													class="cart-drawer__discount-pill js-cart-discount-pill"
													data-discount-code="{{ discount_code }}"
													aria-label="{{ 'cart.general.discount_applied' | t: code: discount_code }}"
												>
													<p class="cart-drawer__discount-pill-code">
														{{ discount_code }}
													</p>

													<button
														class="cart-drawer__discount-pill-remove js-cart-discount-pill-remove"
														type="button"
														aria-label="{{ 'cart.general.remove_discount' | t: code: discount_code }}"
													>
														{% render 'icons-small', icon: 'close' %}
													</button>
												</li>
											{% endfor %}
										</ul>
									{%- endif -%}
								</div>
							</div>
						</div>
					</div>
				{%- endif -%}
			{%- endif -%}
		</div>

		{%- if footer != '' -%}
			<div class="drawer__footer cart-drawer__footer">
				{{- footer -}}
			</div>
		{%- endif -%}
	</div>

	{%- render "preloader" -%}
</section>

<script src="{{- 'section-cart-drawer.build.min.js' | asset_url -}}" defer></script>

{% schema %}
{
	"name": "Cart drawer",
	"settings": [
		{
			"type": "header",
			"content": "Cart drawer settings"
		},
		{
			"type": "text",
			"id": "heading",
			"label": "Heading",
			"default": "Your Cart"
		},
		{
			"type": "checkbox",
			"id": "show_cart_items_count",
			"label": "Show items count in the cart",
			"default": true
		},
		{
			"type": "checkbox",
			"id": "show_gift_wrap_button",
			"label": "Show gift wrap button",
			"default": false
		}
	],
	"blocks": [
		{
			"type": "@app"
		},
		{
			"name": "Items",
			"type": "items",
			"limit": 1,
			"settings": []
		},
		{
			"name": "Upsell",
			"type": "upsell",
			"limit": 1,
			"settings": [
				{
					"type": "text",
					"id": "heading",
					"label": "Heading",
					"default": "You might also like"
				},
				{
					"type": "product_list",
					"id": "product_list",
					"label": "Products",
					"limit": 12
				}
			]
		},
		{
			"name": "Shipping bar",
			"type": "shipping",
			"limit": 1,
			"settings": [
				{
					"type": "number",
					"id": "amount",
					"label": "Free shipping amount",
					"default": 100
				},
				{
					"type": "textarea",
					"id": "message",
					"label": "Shipping message",
					"default": "You are only {amount} away from free shipping",
					"info": "The pattern {amount} will be replaced with the remaining amount"
				},
				{
					"type": "textarea",
					"id": "congratulatory_message",
					"label": "Shipping congratulatory message",
					"default": "You got free shipping"
				},
				{
					"type": "image_picker",
					"id": "icon",
					"label": "Congratulatory icon",
					"info": "40 x 40px recommended"
				}
			]
		},
		{
			"name": "Richtext",
			"type": "richtext",
			"limit": 1,
			"settings": [
				{
					"type": "inline_richtext",
					"id": "text",
					"label": "Text"
				},
				{
					"type": "header",
					"content": "Colors"
				},
				{
					"type": "color",
					"id": "text_color",
					"label": "Text",
					"default": "#000"
				},
				{
					"type": "color",
					"id": "text_background_color",
					"label": "Background",
					"default": "transparent"
				}
			]
		}
	],
	"default": {
		"blocks": [
			{
				"type": "items"
			},
			{
				"type": "upsell"
			},
			{
				"type": "shipping"
			}
		]
	}
}
{% endschema %}
